name: Doxygen Automation
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  deploy_main_doxygen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo for generating doxygen
        uses: actions/checkout@v2
        with:
          path: main

      - name: Install Doxygen
        shell: bash
        run: |
          wget -qO- "https://sourceforge.net/projects/doxygen/files/rel-1.9.2/doxygen-1.9.2.linux.bin.tar.gz" | sudo tar --strip-components=1 -xz -C /usr/local
          sudo apt-get install -y libclang-9-dev libclang-cpp9 graphviz

      - name: Generate doxygen
        working-directory: ./main
        shell: bash
        run: |
          doxygen docs/doxygen/config.doxyfile 2>&1 | tee doxyoutput.txt
          if [[ "$(wc -c < doxyoutput.txt | bc)" = "0" ]]; then exit 0; else exit 1; fi

      - name: Checkout the repo for storing doxygen
        uses: actions/checkout@v2
        with:
          path: doxygen

      - name: Create gh-pages branch
        working-directory: ./doxygen
        shell: bash
        run: |
          # Check if the gh-pages branch exists. If not, create it.
          branch_exist=$(git ls-remote --heads origin gh-pages)
          if [[ -z ${existed_in_remote} ]]; then
            git config --global user.name ${{ github.actor }}
            git config --global user.email ${{ github.actor }}@users.noreply.github.com
            git checkout --orphan gh-pages
            git reset --hard
            git commit --allow-empty -m "Created gh-pages branch"
            git push origin gh-pages
          fi

      - name: Replace previous doxygen documentation
        shell: bash
        run: |
          rm -rf main
          mv main/docs/doxygen/output/html doxygen/main

      - name: Commit new doxygen
        working-directory: ./doxygen
        run: |
          git config --global user.name ${{ github.actor }}
          git config --global user.email ${{ github.actor }}@users.noreply.github.com
          main_id=$(git rev-parse main)
          git add main
          git commit -m "Doxygen for ${main_id}"
          git push origin gh-pages
